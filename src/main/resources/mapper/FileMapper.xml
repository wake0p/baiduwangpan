<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.baidu.netdisk.fileop.Mapper.FileMapper">

    <!-- ===================== 基础查询 ===================== -->
    <select id="getFilesByFolderId" resultType="com.baidu.netdisk.entity.File">
        SELECT * FROM file
        WHERE folder_id = #{folderId}
          AND status = 1
          AND is_deleted = 0
    </select>

    <select id="getFileById" resultType="com.baidu.netdisk.entity.File">
        SELECT * FROM file
        WHERE id = #{fileId}
          AND status = 1
    </select>

    <select id="getFileByNameAndFolderId" resultType="com.baidu.netdisk.entity.File">
        SELECT * FROM file
        WHERE file_name = #{fileName}
          AND folder_id = #{folderId}
          AND status = 1
          AND is_deleted = 0
    </select>

    <!-- ===================== 增删改操作 ===================== -->
    <update id="updateFile">
        UPDATE file
        SET file_name = #{fileName},
            file_type = #{fileType},
            file_size = #{fileSize},
            file_path = #{filePath},
            file_md5 = #{fileMd5},
            folder_id = #{folderId},
            user_id = #{userId},
            status = #{status},
            update_time = NOW()
        WHERE id = #{id}
    </update>

    <select id="getFileByMd5" resultType="com.baidu.netdisk.entity.File">
        SELECT * FROM file
        WHERE file_md5 = #{fileMd5}
    </select>

    <insert id="insertFiles" parameterType="java.util.List">
        INSERT INTO file (file_name, folder_id, file_size, file_type, file_md5, create_time)
        VALUES
        <foreach collection="files" item="file" separator=",">
            (#{file.fileName}, #{file.folderId}, #{file.fileSize}, #{file.fileType}, #{file.fileMd5}, #{file.createTime})
        </foreach>
    </insert>

    <!-- ===================== 逻辑删除操作 ===================== -->
    <update id="updateFileStatus">
        UPDATE file
        SET status = #{status},
            update_time = NOW()
        WHERE id = #{id}
    </update>

    <update id="deleteFilesByFolderId">
        UPDATE file
        SET status = 0,
            update_time = NOW()
        WHERE folder_id = #{folderId}
    </update>

    <!-- ===================== 回收站核心功能 ===================== -->
    <!-- 1. 标记文件为已删除（移入回收站） -->
    <update id="updateToRecycle">
        UPDATE file
        SET is_deleted = 1,
        deleted_time = NOW(),
        deleted_by = #{userId},
        update_time = NOW()
        WHERE id IN
        <foreach collection="fileIds" item="fileId" open="(" separator="," close=")">
            #{fileId}
        </foreach>
        AND user_id = #{userId}
        AND is_deleted = 0
    </update>

    <!-- 2. 从回收站恢复文件 -->
    <update id="restoreFromRecycle">
        UPDATE file
        SET is_deleted = 0,
        deleted_time = NULL,
        deleted_by = NULL,
        update_time = NOW()
        WHERE id IN
        <foreach collection="fileIds" item="fileId" open="(" separator="," close=")">
            #{fileId}
        </foreach>
        AND user_id = #{userId}
        AND is_deleted = 1
    </update>

    <!-- 3. 彻底删除文件（物理删除） -->
    <delete id="deleteFile">
        DELETE FROM file
        WHERE id IN
        <foreach collection="fileIds" item="fileId" open="(" separator="," close=")">
            #{fileId}
        </foreach>
        AND user_id = #{userId}
        AND is_deleted = 1
    </delete>

    <!-- 4. 分页查询回收站文件 -->
    <select id="getRecycleBinFiles" resultType="com.baidu.netdisk.entity.File">
        SELECT * FROM file
        WHERE user_id = #{userId}
          AND is_deleted = 1
        ORDER BY deleted_time DESC
            LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 5. 统计回收站文件总数 -->
    <select id="getRecycleBinFileCount" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM file
        WHERE user_id = #{userId}
          AND is_deleted = 1
    </select>

</mapper>